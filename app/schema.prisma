datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id                        String          @id @default(uuid())
  createdAt                 DateTime        @default(now())

  email                     String?         @unique
  username                  String?         @unique
  isAdmin                   Boolean         @default(false)

  paymentProcessorUserId    String?         @unique
  lemonSqueezyCustomerPortalUrl String?     // You can delete this if you're not using Lemon Squeezy as your payments processor.
  subscriptionStatus        String?         // 'active', 'cancel_at_period_end', 'past_due', 'deleted'
  subscriptionPlan          String?         // 'hobby', 'pro'
  datePaid                  DateTime?
  credits                   Int             @default(3)

  gptResponses              GptResponse[]
  contactFormMessages       ContactFormMessage[]
  tasks                     Task[]
  files                     File[]
  accounts                  Account[]
  categories                Category[]
  transactions              Transaction[]
  budgets                   Budget[]
}

model GptResponse {
  id                        String          @id @default(uuid())
  createdAt                 DateTime        @default(now())
  updatedAt                 DateTime        @updatedAt

  user                      User            @relation(fields: [userId], references: [id])
  userId                    String

  content                   String
}

model Task {
  id                        String          @id @default(uuid())
  createdAt                 DateTime        @default(now())

  user                      User            @relation(fields: [userId], references: [id])
  userId                    String

  description               String
  time                      String          @default("1")
  isDone                    Boolean         @default(false)
}

model File {
  id                        String          @id @default(uuid())
  createdAt                 DateTime        @default(now())

  user                      User            @relation(fields: [userId], references: [id])
  userId                    String

  name                      String
  type                      String
  key                       String
  uploadUrl                 String
}

model DailyStats {
  id                               Int             @id @default(autoincrement())
  date                             DateTime        @default(now()) @unique

  totalViews                       Int             @default(0)
  prevDayViewsChangePercent        String          @default("0")
  userCount                        Int             @default(0)
  paidUserCount                    Int             @default(0)
  userDelta                        Int             @default(0)
  paidUserDelta                    Int             @default(0)
  totalRevenue                     Float           @default(0)
  totalProfit                      Float           @default(0)

  sources                          PageViewSource[]
}

model PageViewSource {
  @@id([date, name])
  name                     String
  date                     DateTime        @default(now())

  dailyStats               DailyStats?     @relation(fields: [dailyStatsId], references: [id])
  dailyStatsId             Int?

  visitors                 Int
}

model Logs {
  id                       Int             @id @default(autoincrement())
  createdAt                DateTime        @default(now())

  message                  String
  level                    String
}

model ContactFormMessage {
  id                        String          @id @default(uuid())
  createdAt                 DateTime        @default(now())

  user                      User            @relation(fields: [userId], references: [id])
  userId                    String

  content                   String
  isRead                    Boolean         @default(false)
  repliedAt                 DateTime?
}

// ==================== FINANÇAS PESSOAIS ====================

enum AccountType {
  CHECKING      // Conta corrente
  SAVINGS       // Poupança
  CREDIT_CARD   // Cartão de crédito
  CASH          // Dinheiro
  INVESTMENT    // Investimento
  OTHER         // Outro
}

enum TransactionType {
  INCOME        // Entrada/Receita
  EXPENSE       // Saída/Despesa
  TRANSFER      // Transferência entre contas
}

model Account {
  id                        String          @id @default(uuid())
  createdAt                 DateTime        @default(now())
  updatedAt                 DateTime        @updatedAt

  user                      User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId                    String

  name                      String          // Nome da conta (ex: "Conta Corrente Banco X")
  type                      AccountType     // Tipo da conta
  balance                   Float           @default(0) // Saldo atual
  initialBalance            Float           @default(0) // Saldo inicial
  currency                  String          @default("BRL") // Moeda
  color                     String?         // Cor para identificação visual
  icon                      String?         // Ícone para identificação visual
  description               String?         // Descrição adicional
  isActive                  Boolean         @default(true) // Conta ativa ou arquivada

  transactions              Transaction[]
  transfersFrom             Transaction[]   @relation("TransferFrom")
  transfersTo               Transaction[]   @relation("TransferTo")

  @@index([userId])
}

model Category {
  id                        String          @id @default(uuid())
  createdAt                 DateTime        @default(now())
  updatedAt                 DateTime        @updatedAt

  user                      User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId                    String

  name                      String          // Nome da categoria (ex: "Alimentação", "Salário")
  type                      TransactionType // Tipo: INCOME ou EXPENSE
  color                     String?         // Cor para identificação visual
  icon                      String?         // Ícone para identificação visual
  description               String?         // Descrição adicional
  isActive                  Boolean         @default(true) // Categoria ativa ou arquivada

  transactions              Transaction[]
  budgets                   Budget[]

  @@index([userId])
  @@index([type])
}

model Transaction {
  id                        String          @id @default(uuid())
  createdAt                 DateTime        @default(now())
  updatedAt                 DateTime        @updatedAt

  user                      User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId                    String

  account                   Account         @relation(fields: [accountId], references: [id], onDelete: Cascade)
  accountId                 String

  category                  Category?       @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  categoryId                String?

  type                      TransactionType // Tipo: INCOME, EXPENSE ou TRANSFER
  amount                    Float           // Valor da transação
  description               String          // Descrição da transação
  date                      DateTime        // Data da transação
  
  // Campos para transferências entre contas
  transferFromAccount       Account?        @relation("TransferFrom", fields: [transferFromAccountId], references: [id], onDelete: SetNull)
  transferFromAccountId     String?
  transferToAccount         Account?        @relation("TransferTo", fields: [transferToAccountId], references: [id], onDelete: SetNull)
  transferToAccountId       String?

  // Campos adicionais
  notes                     String?         // Notas adicionais
  tags                      String[]        // Tags para organização
  isRecurring               Boolean         @default(false) // Se é uma transação recorrente
  recurringFrequency        String?         // Frequência (DAILY, WEEKLY, MONTHLY, YEARLY)
  attachmentUrl             String?         // URL de anexo (nota fiscal, comprovante)

  @@index([userId])
  @@index([accountId])
  @@index([categoryId])
  @@index([date])
  @@index([type])
}

model Budget {
  id                        String          @id @default(uuid())
  createdAt                 DateTime        @default(now())
  updatedAt                 DateTime        @updatedAt

  user                      User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId                    String

  category                  Category        @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  categoryId                String

  name                      String          // Nome do orçamento
  amount                    Float           // Valor do orçamento
  period                    String          @default("MONTHLY") // Período: WEEKLY, MONTHLY, YEARLY
  startDate                 DateTime        // Data de início
  endDate                   DateTime?       // Data de fim (opcional)
  isActive                  Boolean         @default(true) // Orçamento ativo

  @@index([userId])
  @@index([categoryId])
  @@index([period])
}
